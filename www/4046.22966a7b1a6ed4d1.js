"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4046],{4046:(D,v,b)=>{b.r(v),b.d(v,{FilesystemWeb:()=>m});var c=b(1670),R=b(6549);function x(f){const i=f.split("/").filter(r=>"."!==r),t=[];return i.forEach(r=>{".."===r&&t.length>0&&".."!==t[t.length-1]?t.pop():t.push(r)}),t.join("/")}class m extends R.Uw{constructor(){super(...arguments),this.DB_VERSION=1,this.DB_NAME="Disc",this._writeCmds=["add","put","delete"]}initDb(){var i=this;return(0,c.Z)(function*(){if(void 0!==i._db)return i._db;if(!("indexedDB"in window))throw i.unavailable("This browser doesn't support IndexedDB");return new Promise((t,r)=>{const e=indexedDB.open(i.DB_NAME,i.DB_VERSION);e.onupgradeneeded=m.doUpgrade,e.onsuccess=()=>{i._db=e.result,t(e.result)},e.onerror=()=>r(e.error),e.onblocked=()=>{console.warn("db blocked")}})})()}static doUpgrade(i){const r=i.target.result;i.oldVersion,r.objectStoreNames.contains("FileStorage")&&r.deleteObjectStore("FileStorage"),r.createObjectStore("FileStorage",{keyPath:"path"}).createIndex("by_folder","folder")}dbRequest(i,t){var r=this;return(0,c.Z)(function*(){const e=-1!==r._writeCmds.indexOf(i)?"readwrite":"readonly";return r.initDb().then(n=>new Promise((s,d)=>{const u=n.transaction(["FileStorage"],e).objectStore("FileStorage")[i](...t);u.onsuccess=()=>s(u.result),u.onerror=()=>d(u.error)}))})()}dbIndexRequest(i,t,r){var e=this;return(0,c.Z)(function*(){const n=-1!==e._writeCmds.indexOf(t)?"readwrite":"readonly";return e.initDb().then(s=>new Promise((d,a)=>{const h=s.transaction(["FileStorage"],n).objectStore("FileStorage").index(i)[t](...r);h.onsuccess=()=>d(h.result),h.onerror=()=>a(h.error)}))})()}getPath(i,t){const r=void 0!==t?t.replace(/^[/]+|[/]+$/g,""):"";let e="";return void 0!==i&&(e+="/"+i),""!==t&&(e+="/"+r),e}clear(){var i=this;return(0,c.Z)(function*(){(yield i.initDb()).transaction(["FileStorage"],"readwrite").objectStore("FileStorage").clear()})()}readFile(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path),e=yield t.dbRequest("get",[r]);if(void 0===e)throw Error("File does not exist.");return{data:e.content?e.content:""}})()}writeFile(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path);let e=i.data;const n=i.encoding,s=i.recursive,d=yield t.dbRequest("get",[r]);if(d&&"directory"===d.type)throw Error("The supplied path is a directory.");const a=r.substr(0,r.lastIndexOf("/"));if(void 0===(yield t.dbRequest("get",[a]))){const h=a.indexOf("/",1);if(-1!==h){const p=a.substr(h);yield t.mkdir({path:p,directory:i.directory,recursive:s})}}if(!n&&(e=e.indexOf(",")>=0?e.split(",")[1]:e,!t.isBase64String(e)))throw Error("The supplied data is not valid base64 content.");const u=Date.now(),l={path:r,folder:a,type:"file",size:e.length,ctime:u,mtime:u,content:e};return yield t.dbRequest("put",[l]),{uri:l.path}})()}appendFile(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path);let e=i.data;const n=i.encoding,s=r.substr(0,r.lastIndexOf("/")),d=Date.now();let a=d;const o=yield t.dbRequest("get",[r]);if(o&&"directory"===o.type)throw Error("The supplied path is a directory.");if(void 0===(yield t.dbRequest("get",[s]))){const h=s.indexOf("/",1);if(-1!==h){const p=s.substr(h);yield t.mkdir({path:p,directory:i.directory,recursive:!0})}}if(!n&&!t.isBase64String(e))throw Error("The supplied data is not valid base64 content.");void 0!==o&&(e=void 0===o.content||n?o.content+e:btoa(atob(o.content)+atob(e)),a=o.ctime);const l={path:r,folder:s,type:"file",size:e.length,ctime:a,mtime:d,content:e};yield t.dbRequest("put",[l])})()}deleteFile(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path);if(void 0===(yield t.dbRequest("get",[r])))throw Error("File does not exist.");if(0!==(yield t.dbIndexRequest("by_folder","getAllKeys",[IDBKeyRange.only(r)])).length)throw Error("Folder is not empty.");yield t.dbRequest("delete",[r])})()}mkdir(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path),e=i.recursive,n=r.substr(0,r.lastIndexOf("/")),s=(r.match(/\//g)||[]).length,d=yield t.dbRequest("get",[n]),a=yield t.dbRequest("get",[r]);if(1===s)throw Error("Cannot create Root directory");if(void 0!==a)throw Error("Current directory does already exist.");if(!e&&2!==s&&void 0===d)throw Error("Parent directory must exist");if(e&&2!==s&&void 0===d){const l=n.substr(n.indexOf("/",1));yield t.mkdir({path:l,directory:i.directory,recursive:e})}const o=Date.now(),u={path:r,folder:n,type:"directory",size:0,ctime:o,mtime:o};yield t.dbRequest("put",[u])})()}rmdir(i){var t=this;return(0,c.Z)(function*(){const{path:r,directory:e,recursive:n}=i,s=t.getPath(e,r),d=yield t.dbRequest("get",[s]);if(void 0===d)throw Error("Folder does not exist.");if("directory"!==d.type)throw Error("Requested path is not a directory");const a=yield t.readdir({path:r,directory:e});if(0!==a.files.length&&!n)throw Error("Folder is not empty");for(const o of a.files){const u=`${r}/${o.name}`;"file"===(yield t.stat({path:u,directory:e})).type?yield t.deleteFile({path:u,directory:e}):yield t.rmdir({path:u,directory:e,recursive:n})}yield t.dbRequest("delete",[s])})()}readdir(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path),e=yield t.dbRequest("get",[r]);if(""!==i.path&&void 0===e)throw Error("Folder does not exist.");const n=yield t.dbIndexRequest("by_folder","getAllKeys",[IDBKeyRange.only(r)]);return{files:yield Promise.all(n.map(function(){var d=(0,c.Z)(function*(a){let o=yield t.dbRequest("get",[a]);return void 0===o&&(o=yield t.dbRequest("get",[a+"/"])),{name:a.substring(r.length+1),type:o.type,size:o.size,ctime:o.ctime,mtime:o.mtime,uri:o.path}});return function(a){return d.apply(this,arguments)}}()))}})()}getUri(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path);let e=yield t.dbRequest("get",[r]);return void 0===e&&(e=yield t.dbRequest("get",[r+"/"])),{uri:(null==e?void 0:e.path)||r}})()}stat(i){var t=this;return(0,c.Z)(function*(){const r=t.getPath(i.directory,i.path);let e=yield t.dbRequest("get",[r]);if(void 0===e&&(e=yield t.dbRequest("get",[r+"/"])),void 0===e)throw Error("Entry does not exist.");return{type:e.type,size:e.size,ctime:e.ctime,mtime:e.mtime,uri:e.path}})()}rename(i){var t=this;return(0,c.Z)(function*(){yield t._copy(i,!0)})()}copy(i){var t=this;return(0,c.Z)(function*(){return t._copy(i,!1)})()}requestPermissions(){return(0,c.Z)(function*(){return{publicStorage:"granted"}})()}checkPermissions(){return(0,c.Z)(function*(){return{publicStorage:"granted"}})()}_copy(i,t=!1){var r=this;return(0,c.Z)(function*(){let{toDirectory:e}=i;const{to:n,from:s,directory:d}=i;if(!n||!s)throw Error("Both to and from must be provided");e||(e=d);const a=r.getPath(d,s),o=r.getPath(e,n);if(a===o)return{uri:o};if(function q(f,i){f=x(f),i=x(i);const t=f.split("/"),r=i.split("/");return f!==i&&t.every((e,n)=>e===r[n])}(a,o))throw Error("To path cannot contain the from path");let u;try{u=yield r.stat({path:n,directory:e})}catch(g){const y=n.split("/");y.pop();const _=y.join("/");if(y.length>0&&"directory"!==(yield r.stat({path:_,directory:e})).type)throw new Error("Parent directory of the to path is a file")}if(u&&"directory"===u.type)throw new Error("Cannot overwrite a directory with a file");const l=yield r.stat({path:s,directory:d}),h=function(){var g=(0,c.Z)(function*(y,_,w){const E=r.getPath(e,y),P=yield r.dbRequest("get",[E]);P.ctime=_,P.mtime=w,yield r.dbRequest("put",[P])});return function(_,w,E){return g.apply(this,arguments)}}(),p=l.ctime?l.ctime:Date.now();switch(l.type){case"file":{const g=yield r.readFile({path:s,directory:d});t&&(yield r.deleteFile({path:s,directory:d}));const y=yield r.writeFile({path:n,directory:e,data:g.data});return t&&(yield h(n,p,l.mtime)),y}case"directory":{if(u)throw Error("Cannot move a directory over an existing object");try{yield r.mkdir({path:n,directory:e,recursive:!1}),t&&(yield h(n,p,l.mtime))}catch(y){}const g=(yield r.readdir({path:s,directory:d})).files;for(const y of g)yield r._copy({from:`${s}/${y}`,to:`${n}/${y}`,directory:d,toDirectory:e},t);t&&(yield r.rmdir({path:s,directory:d}))}}return{uri:o}})()}isBase64String(i){try{return btoa(atob(i))==i}catch(t){return!1}}}m._debug=!0}}]);
//# sourceMappingURL=4046.22966a7b1a6ed4d1.js.map